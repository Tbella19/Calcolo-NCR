<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Reintegri Cassa NCR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <base target="_top">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .input-field {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            width: 100%;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #3b82f6;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .table-row-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .table-cell {
            flex: 1 1 calc(50% - 0.5rem);
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 640px) {
            .table-row-group {
                display: grid;
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .table-cell {
                flex-basis: auto;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">
    <div class="max-w-3xl w-full space-y-6">
        <header class="text-center mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Gestore Reintegri Cassa NCR</h1>
            <p class="text-gray-600 mt-2">Inserisci i dati per calcolare i reintegri.</p>
        </header>

        <main class="space-y-6">
            <section class="container-card">
                <div class="space-y-4">
                    <label for="cassa-number" class="block text-sm font-medium text-gray-700">Numero Cassa</label>
                    <div class="flex items-center space-x-4">
                        <input type="number" id="cassa-number" placeholder="Inserisci il numero" class="input-field">
                        <button id="save-btn" class="btn btn-secondary whitespace-nowrap">Salva Reintegro</button>
                    </div>
                </div>
            </section>

            <section class="container-card">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Acquisizione Dati da Immagine</h2>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <button id="upload-btn" class="btn btn-primary w-full sm:w-1/2">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        Carica Foto
                    </button>
                    <button id="camera-btn" class="btn btn-primary w-full sm:w-1/2">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Scatta Foto
                    </button>
                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                    <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;">
                </div>
                <div id="status-message" class="mt-4 text-center text-sm font-medium text-red-500 hidden"></div>
                <div id="loading-spinner" class="mt-4 text-center" style="display: none;">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-gray-200 border-t-blue-500 rounded-full"></div>
                </div>
            </section>

            <section class="container-card">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Quantità in Cassa</h2>
                <div class="table-row-group">
                    <div class="table-cell">
                        <label class="block text-sm font-medium text-gray-700">Monete</label>
                        <div class="space-y-2 mt-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-600">0.01€</span>
                                <input type="number" id="val-0-01" value="0" min="0" class="input-field">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-600">0.02€</span>
                                <input type="number" id="val-0-02" value="0" min="0" class="input-field">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-600">0.05€</span>
                                <input type="number" id="val-0-05" value="0" min="0" class="input-field">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-600">0.10€</span>
                                <input type="number" id="val-0-10" value="0" min="0" class="input-field">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-600">0.20€</span>
                                <input type="number" id="val-0-20" value="0" min="0" class="input-field">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-600">0.50€</span>
                                <input type="number" id="val-0-50" value="0" min="0" class="input-field">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-600">1€</span>
                                <input type="number" id="val-1" value="0" min="0" class="input-field">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-600">2€</span>
                                <input type="number" id="val-2" value="0" min="0" class="input-field">
                            </div>
                        </div>
                    </div>
                    <div class="table-cell">
                        <label class="block text-sm font-medium text-gray-700">Banconote</label>
                        <div class="space-y-2 mt-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-600">5€</span>
                                <input type="number" id="val-5" value="0" min="0" class="input-field">
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-600">10€</span>
                                <input type="number" id="val-10" value="0" min="0" class="input-field">
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const API_KEY = ""; // L'API Key sarà fornita dall'ambiente di esecuzione
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`;
        const loadingSpinner = document.getElementById('loading-spinner');
        const statusMessage = document.getElementById('status-message');
        const fileInput = document.getElementById('file-input');
        const cameraInput = document.getElementById('camera-input');
        const uploadBtn = document.getElementById('upload-btn');
        const cameraBtn = document.getElementById('camera-btn');
        const inputFields = {
            '0.01': document.getElementById('val-0-01'),
            '0.02': document.getElementById('val-0-02'),
            '0.05': document.getElementById('val-0-05'),
            '0.10': document.getElementById('val-0-10'),
            '0.20': document.getElementById('val-0-20'),
            '0.50': document.getElementById('val-0-50'),
            '1': document.getElementById('val-1'),
            '2': document.getElementById('val-2'),
            '5': document.getElementById('val-5'),
            '10': document.getElementById('val-10')
        };
        const cassaNumberInput = document.getElementById('cassa-number');
        const saveBtn = document.getElementById('save-btn');

        uploadBtn.addEventListener('click', () => fileInput.click());
        cameraBtn.addEventListener('click', () => cameraInput.click());

        fileInput.addEventListener('change', (event) => handleFile(event.target.files[0]));
        cameraInput.addEventListener('change', (event) => handleFile(event.target.files[0]));

        async function handleFile(file) {
            if (!file) return;

            statusMessage.textContent = '';
            statusMessage.style.display = 'none';
            loadingSpinner.style.display = 'block';
            for (let key in inputFields) {
                inputFields[key].value = 0;
            }

            try {
                const base64Data = await fileToBase64(file);
                const results = await callGeminiAPI(base64Data);
                parseAndFillForm(results);
            } catch (error) {
                console.error("Errore durante l'analisi:", error);
                statusMessage.textContent = 'Errore nell\'analisi. Assicurati che l\'immagine sia chiara e riprova.';
                statusMessage.style.display = 'block';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function callGeminiAPI(base64Data) {
            const prompt = `Analizza l'immagine di un display NCR di una cassa. Estrai solo i dati relativi alle monete (1, 2, 5, 10, 20, 50 centesimi e 1, 2 euro) e alle banconote da 5 e 10 euro. Devi ignorare tutti gli altri tagli di banconote. Formatta la risposta come un JSON array. Per ogni oggetto nel JSON, usa la chiave "valore" per il taglio di moneta o banconota e "quantita" per la quantità. Ad esempio: [{"valore": "0.50", "quantita": "12"}, {"valore": "1", "quantita": "25"}, {"valore": "5", "quantita": "30"}]. Assicurati di non includere testo descrittivo, solo l'array JSON. Se non trovi un valore, non includerlo nel JSON.`;
            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json"
                }
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorText}`);
            }

            const result = await response.json();
            const textResult = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!textResult) {
                throw new Error("La risposta dell'API non contiene il testo.");
            }
            return JSON.parse(textResult);
        }

        function parseAndFillForm(data) {
            let foundData = false;
            for (let key in inputFields) {
                inputFields[key].value = 0;
            }
            data.forEach(item => {
                let cleanedValue = item.valore.replace(',', '.').trim();
                let key = parseFloat(cleanedValue).toString();
                if (inputFields[key]) {
                    inputFields[key].value = parseInt(item.quantita, 10) || 0;
                    foundData = true;
                }
            });

            if (!foundData) {
                statusMessage.textContent = 'Nessun dato riconosciuto. Assicurati che l\'immagine mostri chiaramente le quantità.';
                statusMessage.style.display = 'block';
            }
        }
    </script>
</body>
</html>
